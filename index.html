<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chrionml© AI City Insights Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root{--bg:#f5f5f7;--surface:#fff;--surface-ghost:rgba(255,255,255,.82);--border:#e5e7eb;--text:#111827;--muted:#6b7280;--accent:#1a73e8;--accent-contrast:#fff;--zebra:#f9fafb;--shadow:0 8px 24px rgba(16,24,40,.08)}
    @media (prefers-color-scheme: dark){
      :root{--bg:#0b0c0f;--surface:#121417;--surface-ghost:rgba(18,20,23,.82);--border:#2a2f36;--text:#eef2f6;--muted:#a6adbb;--accent:#8ab4f8;--accent-contrast:#0b0c0f;--zebra:#151922;--shadow:0 10px 30px rgba(2,6,23,.6)}
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #map{position:fixed;inset:0;width:100vw;height:100vh}
    #drawerToggle{position:fixed;top:16px;right:16px;width:72px;height:72px;background:var(--accent);color:var(--accent-contrast);border:none;border-radius:50%;font-size:.62rem;line-height:1.15;padding:0 6px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow);z-index:3}
    #drawer{position:fixed;top:16px;left:16px;width:260px;height:calc(100% - 32px);background:var(--surface-ghost);padding:14px;z-index:2;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:auto;backdrop-filter:saturate(160%) blur(14px);-webkit-backdrop-filter:saturate(160%) blur(14px);transform:translateX(-20px);opacity:0;pointer-events:none;transition:transform .25s,opacity .25s}
    #drawer.open{transform:translateX(0);opacity:1;pointer-events:auto}
    #drawer h2{font-size:.95rem;line-height:1.25;margin:2px 0 12px;text-align:center}
    .h2-top,.h2-bottom{display:block;white-space:nowrap}.h2-top{font-weight:700}.h2-bottom{font-weight:600;color:var(--muted)}
    table{width:100%;font-size:.8rem;border-collapse:collapse;background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{padding:10px 8px;text-align:left;border-bottom:1px solid var(--border);font-weight:700}
    tbody td{padding:10px 8px;border-bottom:1px solid var(--border)}tbody tr:nth-child(even) td{background:var(--zebra)}tbody tr:last-child td{border-bottom:none}
    .marker{width:16px;height:16px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px #fff,0 6px 12px rgba(0,0,0,.15)}
    @media (prefers-color-scheme: dark){.marker{box-shadow:0 0 0 3px #0b0c0f,0 6px 12px rgba(0,0,0,.6)}}
    .mapboxgl-popup-content{font-size:.85rem;border-radius:12px!important;border:1px solid var(--border);box-shadow:var(--shadow);color:var(--text);background:var(--surface)}
    #debug{position:fixed;left:0;right:0;bottom:0;background:#fee2e2;color:#991b1b;border-top:1px solid #fecaca;padding:8px 12px;font-size:12px;display:none;z-index:10;white-space:pre-wrap}
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="drawerToggle" onclick="toggleDrawer()">Chrionml©<br>AI Labs</button>
  <div id="drawer" class="open">
    <h2><span class="h2-top">Single-Family</span><span class="h2-bottom">Aug-30-2025 Outlook</span></h2>
    <table><thead><tr><th>City</th><th>Price</th></tr></thead><tbody id="cityTableBody"></tbody></table>
  </div>
  <div id="debug"></div>

  <script>
    // --- CONFIG ---
    mapboxgl.accessToken = 'pk.eyJ1Ijoib2QzIiwiYSI6ImNtZGV3a3FhMTA2dXkyanE1eHpiMGFzaHcifQ.SFRhIljjn0_VnQ6SoKnYIw';
    const styleURL = `https://api.mapbox.com/styles/v1/mapbox/light-v12?access_token=${mapboxgl.accessToken}`;

    // --- DEBUG HELPERS ---
    function showError(text){
      const dbg = document.getElementById('debug');
      dbg.textContent = `Map error: ${text || '(no message)'}`;
      dbg.style.display = 'block';
    }
    window.onerror = (msg,src,line,col,err)=>{ showError(`${msg} @ ${src}:${line}:${col}`); console.error(err||msg); };
    window.addEventListener('unhandledrejection', (e)=>{ showError(`Unhandled promise: ${e.reason && e.reason.message ? e.reason.message : e.reason}`); console.error(e); });

    // Probe the style endpoint early — surfaces 401/403 “URL not allowed” quickly
    fetch(styleURL, {mode:'cors'})
      .then(r => {
        if (!r.ok) { showError(`Style fetch failed: HTTP ${r.status} ${r.statusText}`); }
        return r.text();
      })
      .catch(err => showError(`Style fetch error: ${err.message||err}`));

    if (!mapboxgl.supported()) {
      showError('This browser does not support Mapbox GL / WebGL.');
    } else {
      init();
    }

    function init(){
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v12',
        center: [-98.5795, 39.8283],
        zoom: 3,
        pitch: 45,
        bearing: -17.6,
        antialias: true
      });

      map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-left');
      window.addEventListener('resize', () => map.resize());

      // SAFETY: only try globe; if it fails, fall back to mercator so you see *something*
      map.on('style.load', () => {
        try {
          map.setProjection('globe'); // globe requires supported style & WebGL
          map.setFog({
            color: 'rgb(186, 210, 235)',
            'high-color': 'rgb(36, 92, 223)',
            'space-color': 'rgb(11, 11, 25)',
            'horizon-blend': 0.05
          });
        } catch (e) {
          console.warn('Globe projection failed, falling back to mercator:', e);
          showError('Globe not available — showing flat map instead.');
          try { map.setProjection('mercator'); } catch(_) {}
        }
      });

      map.on('load', () => {
        const cities = [
          { name: "Austin, TX", coords: [-97.7431, 30.2672], price: 512413 },
          { name: "Cambridge, MA", coords: [-71.1097, 42.3736], price: 1670813 },
          { name: "Denver, CO", coords: [-104.9903, 39.7392], price: 577921 },
          { name: "Plymouth, MA", coords: [-70.6673, 41.9584], price: 661533 },
          { name: "Ithaca, NY", coords: [-76.5019, 42.4430], price: 427244 },
          { name: "Salem, OR", coords: [-123.0351, 44.9429], price: 369470 },
          { name: "San Francisco, CA", coords: [-122.4194, 37.7749], price: 899057 },
          { name: "San Jose, CA", coords: [-121.8863, 37.3382], price: 1061257 },
          { name: "Santa Clara, CA", coords: [-121.9552, 37.3541], price: 1786961 },
          { name: "Seattle, WA", coords: [-122.3321, 47.6062], price: 956662 },
          { name: "Waltham, MA", coords: [-71.2358, 42.3765], price: 863003 }
        ];
        cities.forEach(city => {
          const el = document.createElement('div'); el.className = 'marker';
          new mapboxgl.Marker(el)
            .setLngLat(city.coords)
            .setPopup(new mapboxgl.Popup({ offset: 16 }).setHTML(`<strong>${city.name}</strong><br>Price: $${city.price.toLocaleString()}`))
            .addTo(map);
        });
        const sorted = [...cities].sort((a,b) => a.price - b.price);
        document.getElementById('cityTableBody').innerHTML =
          sorted.map(c => `<tr><td>${c.name}</td><td>$${c.price.toLocaleString()}</td></tr>`).join('');
      });

      // Real Mapbox error handler — no circular JSON
      map.on('error', (e) => {
        let msg = '(no message)';
        const err = e && e.error;
        if (err) {
          if (typeof err.message === 'string') msg = err.message;
          else if (err.status || err.statusText) msg = `HTTP ${err.status||''} ${err.statusText||''}`.trim();
          else msg = String(err);
        }
        showError(msg);
        console.error('Mapbox error event:', e);
      });

      // Expose toggle for the button
      window.toggleDrawer = function(){ document.getElementById('drawer').classList.toggle('open'); };
    }
  </script>
</body>
</html>
